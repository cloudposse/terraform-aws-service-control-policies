#
# This policy denies instance types that aren't based on the Nitro system as documented in the following document:
# https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html#ec2-nitro-instances
# List of Nitro-enabled instances updated 2023-06-23
#
- sid: "DenyEC2NonNitroInstances"
  effect: "Deny"
  actions:
    - "ec2:RunInstances"
  condition:
    - test: "StringNotLike"
      variable: "ec2:InstanceType"
      values:
        - a1.*
        - c5.*
        - c5a.*
        - c5ad.*
        - c5d.*
        - c5n.*
        - c6a.*
        - c6g.*
        - c6gd.*
        - c6gn.*
        - c6i.*
        - c6id.*
        - c6in.*
        - c7g.*
        - c7gn.*
        - d3.*
        - d3en.*
        - dl1.*
        - g4ad.*
        - g4dn.*
        - g5.*
        - g5g.*
        - hpc6a.*
        - hpc6id.*
        - hpc7g.*
        - i3.metal
        - i3en.*
        - i4g.*
        - i4i.*
        - im4gn.*
        - inf1.*
        - inf2.*
        - is4gen.*
        - m5.*
        - m5a.*
        - m5ad.*
        - m5d.*
        - m5dn.*
        - m5n.*
        - m5zn.*
        - m6a.*
        - m6g.*
        - m6gd.*
        - m6i.*
        - m6id.*
        - m6idn.*
        - m6in.*
        - m7g.*
        - mac1.metal
        - mac2.metal
        - p3dn.*
        - p4d.*
        - p4de.*
        - r5.*
        - r5a.*
        - r5ad.*
        - r5b.*
        - r5d.*
        - r5dn.*
        - r5n.*
        - r6a.*
        - r6g.*
        - r6gd.*
        - r6i.*
        - r6id.*
        - r6idn.*
        - r6in.*
        - r7g.*
        - t3.*
        - t3a.*
        - t4g.*
        - trn1.*
        - trn1n.*
        - u-12tb1.*
        - u-18tb1.metal
        - u-24tb1.metal
        - u-3tb1.*
        - u-6tb1.*
        - u-9tb1.*
        - vt1.*
        - x2gd.*
        - x2idn.*
        - x2iedn.*
        - x2iezn.*
        - z1d.*

  resources:
    - "arn:aws:ec2:*:*:instance/*"

# This policy denies instance types that do not support Encryption-in-Transit as
# described in the following document:
# https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/data-protection.html#encryption-transit
# and enumerated by the following command (specified in the documentation):
#
#  aws ec2 describe-instance-types \
#  --filters Name=network-info.encryption-in-transit-supported,Values=true \
#  --query "InstanceTypes[*].[InstanceType]" --output text | sort
- sid: "DenyEC2InstancesWithoutEncryptionInTransit"
  effect: "Deny"
  actions:
    - "ec2:RunInstances"
  condition:
    - test: "StringNotEquals"
      variable: "ec2:InstanceType"
      values:
      # updated 2023-06-23
        - c5a.*
        - c5ad.*
        - c5n.*
        - c6a.*
        - c6gn.*
        - c6i.*
        - c6id.*
        - c6in.*
        - c7g.*
        - c7gn.*
        - d3.*
        - d3en.*
        - dl1.*
        - g4ad.*
        - g4dn.*
        - g5.*
        - hpc6a.*
        - hpc6id.*
        - hpc7g.*
        - i3en.*
        - i4g.*
        - i4i.*
        - im4gn.*
        - inf1.*
        - inf2.*
        - is4gen.*
        - m5dn.*
        - m5n.*
        - m5zn.*
        - m6a.*
        - m6i.*
        - m6id.*
        - m6idn.*
        - m6in.*
        - m7g.*
        - p3dn.*
        - p4d.*
        - p4de.*
        - r5dn.*
        - r5n.*
        - r6a.*
        - r6i.*
        - r6id.*
        - r6idn.*
        - r6in.*
        - r7g.*
        - trn1.*
        - trn1n.*
        - u-12tb1.*
        - u-18tb1.*
        - u-24tb1.*
        - u-3tb1.*
        - u-6tb1.*
        - u-9tb1.*
        - vt1.*
        - x2idn.*
        - x2iedn.*
        - x2iezn.*
  resources:
    - "arn:aws:ec2:*:*:instance/*"

- sid: "DenyEC2PublicAMI"
  effect: "Deny"
  actions:
    - "ec2:RunInstances"
  condition:
    - test: "Bool"
      variable: "ec2:Public"
      values:
        - true
  resources:
    - "arn:aws:ec2:*::image/*"

- sid: "DenyEC2AssociatePublicIp"
  effect: "Deny"
  actions:
    - "ec2:RunInstances"
  condition:
    - test: "Bool"
      variable: "ec2:AssociatePublicIpAddress"
      values:
        - true
  resources:
    - "arn:aws:ec2:*:*:network-interface/*"

- sid: "DenyEC2WithNoIMDSv2"
  effect: "Deny"
  actions:
    - "ec2:RunInstances"
  condition:
    - test: "StringNotEquals"
      variable: "ec2:MetadataHttpTokens"
      values:
        - "required"
  resources:
    - "arn:aws:ec2:*:*:instance/*"

- sid: "DenyEC2ApiWithNoMFA"
  effect: "Deny"
  actions:
    - "ec2:StopInstances"
    - "ec2:TerminateInstances"
    - "ec2:SendDiagnosticInterrupt"
  condition:
    - test: "BoolIfExists"
      variable: "aws:MultiFactorAuthPresent"
      values:
        - false
  resources:
    - "*"
